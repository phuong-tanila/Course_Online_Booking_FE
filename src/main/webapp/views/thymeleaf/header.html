<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />
    <link
      rel="icon"
      href="../../resources/img/qtc-logo-black.png"
      type="image/png"
    />
    <title>The Best IT Training Center - 100+ Courses | QTCenter.com</title>
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="../../resources/css/bootstrap.css" />
    <link rel="stylesheet" href="../../resources/css/flaticon.css" />
    <link rel="stylesheet" href="../../resources/css/themify-icons.css" />
    <link
      rel="stylesheet"
      href="../../resources/vendors/owl-carousel/owl.carousel.min.css"
    />
    <link
      rel="stylesheet"
      href="../../resources/vendors/nice-select/css/nice-select.css"
    />
    <link rel="stylesheet" href="../../resources/css/header.css" />
    <!-- main css -->
    <link rel="stylesheet" href="../../resources/css/style.css" />
  </head>
  <body>
    <header class="header_area" th:fragment="header">
      <script
        src="https://kit.fontawesome.com/1aa19ebad3.js"
        crossorigin="anonymous"
      ></script>
      <div class="main_menu">
        <div class="search_input" id="search_input_box">
          <div class="container" style="position: relative">
            <form
              class="d-flex justify-content-between"
              method="GET"
              th:action="@{'/search/tuitionFee,asc'}"
            >
              <input
                name="name"
                type="text"
                class="form-control"
                id="search_input"
                placeholder="Search for any courses"
              />
              <ul id="search_result" class="search_result"></ul>
              <button type="submit" class="btn"></button>
              <span
                class="ti-close"
                id="close_search"
                title="Close Search"
              ></span>
            </form>
          </div>
        </div>

        <nav class="navbar navbar-expand-lg navbar-light">
          <div class="container">
            <!-- Brand and toggle get grouped for better mobile display -->
            <a class="navbar-brand logo_h" href="/home"
              ><img
                class="img-logo"
                src="../../resources/img/LOGO QT CENTER.png"
                alt="Logo"
            /></a>
            <button
              class="navbar-toggler"
              type="button"
              data-toggle="collapse"
              data-target="#navbarSupportedContent"
              aria-controls="navbarSupportedContent"
              aria-expanded="false"
              aria-label="Toggle navigation"
            >
              <span class="icon-bar"></span> <span class="icon-bar"></span>
              <span class="icon-bar"></span>
            </button>
            <!-- Collect the nav links, forms, and other content for toggling -->
            <div
              class="collapse navbar-collapse offset"
              id="navbarSupportedContent"
            >
              <ul class="nav navbar-nav menu_nav ml-auto">
                <li class="nav-item">
                  <a class="nav-link" href="/contact-us">Contact</a>
                </li>
                <li class="nav-item submenu dropdown">
                  <a
                    href="#"
                    class="nav-link dropdown-toggle"
                    data-toggle="dropdown"
                    role="button"
                    >Categories</a
                  >
                  <ul
                    class="dropdown-menu"
                    style="box-shadow: rgba(0, 0, 0, 0.24) 0px 3px 8px"
                  >
                    <li class="nav-item" th:each="cate: ${session.categories}">
                      <a
                        class="nav-link"
                        th:text="${cate.categoryName}"
                        th:href="@{/categories/tuitionFee,asc (categoryId=${cate.id})}"
                      ></a>
                    </li>
                  </ul>
                </li>
                <li class="nav-item" id="cart">
                  <a href="/cart" class="nav-link">
                    <i class="ti-shopping-cart"></i>
                  </a>
                </li>
                <li class="nav-item" id="userInfo">
                  <a
                    href="#"
                    class="nav-link"
                    onclick="document.getElementById('login-form').style.display='block'"
                    >Login
                  </a>
                </li>
                <div id="login-form" class="modal">
                  <form
                    class="modal-content animate"
                    action="/login"
                    method="POST"
                  >
                    <div class="imgcontainer">
                      <span
                        onclick="document.getElementById('login-form').style.display = 'none'"
                        class="close"
                        title="Close Modal"
                        >&times;</span
                      >
                    </div>

                    <div class="container">
                      <label for="username"><b>Username or Phone</b></label>
                      <input
                        type="text"
                        placeholder="Enter Username Or Phone"
                        name="email"
                        id="email-input"
                        required
                      />

                      <label for="psw"><b>Password</b></label>
                      <input
                        type="password"
                        placeholder="Enter Password"
                        name="password"
                        id="password-input"
                        required
                      />
                      <h3 id="msg" style="color: red"></h3>
                      <button type="submit" class="modal-login-btn">
                        Login
                      </button>
                      <div
                        id="g_id_onload"
                        data-client_id="517352653612-kg4v25jpt8hmrttbhch06quva55l44v5.apps.googleusercontent.com"
                        data-context="signin"
                        data-ux_mode="popup"
                        data-callback="loginByGoogle"
                        data-itp_support="true"
                      ></div>

                      <div
                        class="g_id_signin"
                        data-type="standard"
                        data-shape="pill"
                        data-theme="outline"
                        data-text="signin_with"
                        data-size="large"
                        data-logo_alignment="left"
                      ></div>

                      <div class="remember-me">
                        <label>
                          <input
                            type="checkbox"
                            checked="checked"
                            name="remember"
                          />
                          Remember me
                        </label>
                        <span class="psw"
                          >Forgot
                          <a href="forgot-pwd-form.html">password?</a></span
                        >
                      </div>
                    </div>

                    <div class="container" style="background-color: #f1f1f1">
                      <button
                        type="button"
                        onclick="document.getElementById('login-form').style.display = 'none'"
                        class="cancelbtn"
                      >
                        Cancel
                      </button>
                      <div style="float: right; margin-top: 3%">
                        <p>
                          Don't have an account?
                          <a th:href="@{~/register-form}">Sign Up</a>
                        </p>
                      </div>
                    </div>
                  </form>
                </div>

                <li class="nav-item">
                  <a href="#" class="nav-link search" id="search">
                    <i class="ti-search"></i>
                  </a>
                </li>
              </ul>
            </div>
          </div>
          <script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
          <script
            src="https://accounts.google.com/gsi/client"
            async
            defer
          ></script>
          <script>
            function deleteCookie(name) {
              document.cookie =
                name + "=; Path=/; Expires=Thu, 01 Jan 1970 00:00:01 GMT;";
            }
            function setCookie(name, value, days) {
              var expires = "";
              if (days) {
                var date = new Date();
                date.setTime(date.getTime() + days * 24 * 60 * 60 * 1000);
                expires = "; expires=" + date.toUTCString();
              }
              document.cookie =
                name + "=" + (value || "") + expires + "; path=/";
            }
            function getCookie(name) {
              var nameEQ = name + "=";
              var ca = document.cookie.split(";");
              for (var i = 0; i < ca.length; i++) {
                var c = ca[i];
                while (c.charAt(0) == " ") c = c.substring(1, c.length);
                if (c.indexOf(nameEQ) == 0)
                  return c.substring(nameEQ.length, c.length);
              }
              return null;
            }
            function eraseCookie(name) {
              document.cookie =
                name + "=; Path=/; Expires=Thu, 01 Jan 1970 00:00:01 GMT;";
            }
            function displayLoginedUser(claims){
                    const accessToken = localStorage.getItem("accessToken");
                    if(accessToken != null){
                        const claims = decodeJwtResponse(accessToken);
                        if(claims.role != "US") document.querySelector("#cart").style.display = 'none'
                        const userInfoDropDown = document.querySelector("#userInfo");

                        userInfoDropDown.classList.add("submenu");
                        userInfoDropDown.classList.add("dropdown");
                        userInfoDropDown.innerHTML = `
                            <!-- Avatar user after login success -->
                <li class="nav-item submenu dropdown">
                    <a
                      href="#"
                      class="nav-link dropdown-toggle avatar_user"
                      data-toggle="dropdown"
                      role="button"
                      aria-haspopup="true"
                      aria-expanded="false"
                      ><img class="avatar_user_image" src="${claims.avatar}"
                    /></a>
                    <ul class="dropdown-menu">
                      <li class="nav-item">
                        <a class="nav-link" href="/profile">Edit profile</a>
                      </li>
                      ${claims.role == "US" ? `<li class="nav-item">
                        <a class="nav-link" href="/history">Purchase history</a>
                      </li>` : ""}
                      ${claims.role == "AD" ? `<li class="nav-item">
                        <a class="nav-link" href="/dashboard">Dashboard</a>
                      </li>` : ""}
                      ${claims.role == "AD" ? `<li class="nav-item">
                        <a class="nav-link" href="/admin-create">Create course</a>
                      </li>` : ""}
                      ${claims.role == "AD" ? `<li class="nav-item">
                        <a class="nav-link" href="/admin-update">Update course</a>
                      </li>` : ""}
                      <li class="nav-item">
                        <a class="nav-link" style="cursor: pointer;" onclick="logout()">Log out</a>
                      </li>
                    </ul>
                  </li>
                        `
                    }else {
                        google.accounts.id.prompt();
                    }
                }

            function logout() {
              fetch("/logout")
                .then((res) => {
                  if (res.ok) return res;
                })
                .then(() => {
                  localStorage.removeItem("accessToken");
                  localStorage.removeItem("refreshToken");
                  window.location.href = "/home";
                  localStorage.removeItem("cart");
                  if (getCookie("accessToken")) deleteCookie("accessToken");
                  if (getCookie("refreshToken")) deleteCookie("refreshToken");
                });
            }
            window.onload = function () {
              const token = localStorage.getItem("refreshToken");
              let claims = null;
              if (token != null) claims = decodeJwtResponse(token);
              displayLoginedUser(claims);
            };
            function decodeJwtResponse(token) {
              var base64Url = token.split(".")[1];
              var base64 = base64Url.replace(/-/g, "+").replace(/_/g, "/");
              var jsonPayload = decodeURIComponent(
                atob(base64)
                  .split("")
                  .map(function (c) {
                    return (
                      "%" + ("00" + c.charCodeAt(0).toString(16)).slice(-2)
                    );
                  })
                  .join("")
              );
              return JSON.parse(jsonPayload);
            }
            document
              .querySelector("#login-form")
              .addEventListener("submit", (event) => {
                event.preventDefault();
                const email = document
                  .querySelector("#email-input")
                  .value.trim();
                const password = document
                  .querySelector("#password-input")
                  .value.trim();
                if (email != "" && password != "") {
                  const json = {
                    email: email,
                    password: password,
                  };
                  fetch("/login", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify(json)
                  })
                    .then((res) => {
                      if (res.ok) {
                        return res.json();
                      }
                      throw new Error("invalid email/phone or password");
                    })
                    .then((data) => {
                      localStorage.setItem("refreshToken", data.refreshToken);
                      localStorage.setItem("accessToken", data.accessToken);
                      document.getElementById("login-form").style.display =
                        "none";
                      displayLoginedUser();
                    })
                    .catch((err) => {
                      document.querySelector("#msg").innerHTML =
                        "invalid email/phone or password";
                    });
                }
              });

            function loginByGoogle(response) {
              const responsePayload = decodeJwtResponse(response.credential);
              const body = {
                email: responsePayload.email,
                password: "",
              };
              fetch("http://localhost:8083/login/google", {
                method: "POST",
                body: JSON.stringify(body),
                headers: {
                  "Content-Type": "application/json",
                },
              })
                .then((res) => {
                  if (res.ok) return res.json();
                  throw "Your email has not been registered in our system";
                })
                .then((data) => {
                  localStorage.setItem("refreshToken", data.refreshToken);
                  localStorage.setItem("accessToken", data.accessToken);
                  document.getElementById("login-form").style.display = "none";
                  displayLoginedUser(data);
                })
                .catch((err) => {
                  document.querySelector("#msg").innerHTML =
                    "Your email has not been registered in our system";
                  document.getElementById("login-form").style.display = "block";
                });
            }

            let cart = JSON.parse(localStorage.getItem("cart"));

            if (cart == null || cart == "") {
              cart = [];
              localStorage.setItem("cart", JSON.stringify(cart));
            }
          </script>
        </nav>
      </div>
    </header>
  </body>
  <!-- Optional JavaScript -->
  <!-- jQuery first, then Popper.js, then Bootstrap JS -->
  <script src="../../resources/js/jquery-3.2.1.min.js"></script>
  <script src="../../resources/js/popper.js"></script>
  <script src="../../resources/js/bootstrap.min.js"></script>
  <script src="../../resources/vendors/nice-select/js/jquery.nice-select.min.js"></script>
  <script src="../../resources/vendors/owl-carousel/owl.carousel.min.js"></script>
  <script src="../../resources/js/owl-carousel-thumb.min.js"></script>
  <script src="../../resources/js/jquery.ajaxchimp.min.js"></script>
  <script src="../../resources/js/mail-script.js"></script>
  <script src="../../resources/js/login.btn.js"></script>
  <!--gmaps Js-->
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCjCGmQ0Uq4exrzdcL6rvxywDDOvfAu6eE"></script>
  <script src="../../resources/js/gmaps.min.js"></script>
  <script src="../../resources/js/theme.js"></script>
  <script src="../../resources/js/search-ajax.js"></script>
</html>
